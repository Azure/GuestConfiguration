pr: none
trigger:
  batch: true
  branches:
    include:
      - master
  paths:
    exclude:
    - /tools/azure-pipelines-pr.yml
    - /tools/azure-pipelines-release.yml
    - README.md
    - CODE_OF_CONDUCT.md
    - SECURITY.md
    - LICENSE
    - .gitignore
    - .github/*
schedules:
  - cron: "0 0 * * *"
    displayName: Daily midnight build
    branches:
      include:
        - master
jobs:
  - job: Test
    strategy:
      matrix:
        # comment out until bugs are resolved in PSDesiredStateConfiguration
        #Ubuntu:
        #  imageName: ubuntu-latest
        MacOS:
          imageName: macOS-latest
        Windows2019:
          imageName: windows-latest
    pool:
      vmImage: $(imageName)
    steps:
      - task: UniversalPackages@0
        inputs:
          command: download
          feedsToUse: external
          externalFeedCredentials: guestconfiguration
          feedDownloadExternal: guestconfiguration
          packageDownloadExternal: gc_agents
          versionDownloadExternal: '*'
          downloadDirectory: '$(Build.SourcesDirectory)/bin/'
        displayName: Universal download
      - task: PowerShell@2
        inputs:
          targetType: inline
          script: |
            $powerShellPath = Join-Path -Path $env:AGENT_TEMPDIRECTORY -ChildPath 'powershell'
            Invoke-WebRequest -Uri https://raw.githubusercontent.com/PowerShell/PowerShell/master/tools/install-powershell.ps1 -outfile ./install-powershell.ps1
            ./install-powershell.ps1 -Destination $powerShellPath -Preview
            if ($IsMacOS -OR $IsLinux) {$delimiter=':'} else {$delimiter=';'}
            $vstsCommandString = "vso[task.setvariable variable=PATH]$powerShellPath$delimiter$env:PATH"
            Write-Host "sending " + $vstsCommandString
            Write-Host "##$vstsCommandString"
        displayName: Install PowerShell Core
      - task: PowerShell@2
        inputs:
          pwsh: 'true'
          targetType: inline
          script: |
            if ($IsMacOS) { brew install openssl }
            if ($IsLinux) { sudo apt-get install openssl }
        displayName: Install OpenSSL on Mac/Linux
      - task: PowerShell@2
        inputs:
          pwsh: 'true'
          targetType: inline
          script: |
            $repositoryName = ('$(Build.Repository.Name)').split('/')[1]
            $modules = (Import-PowerShellDataFile "$env:BUILD_SOURCESDIRECTORY/$repositoryName.psd1").RequiredModules
            $modules += @('Pester','PowerShellGet','PSScriptAnalyzer')
            write-host "installing " $modules
            Install-Module -Name $modules -Repository 'PSGallery' -Force -AllowClobber -SkipPublisherCheck
        displayName: Install modules
      - task: PowerShell@2
        inputs:
          pwsh: 'true'
          targetType: inline
          script: |
            $PSVersionTable
            if ($true -eq $IsMacOS) { $env:Temp = $env:TMPDIR }
            if ($true -eq $IsLinux) { $env:Temp = & mktemp }
            write-host "temp: $env:Temp"
            Invoke-Pester -Verbose -OutputFile "$env:BUILD_SOURCESDIRECTORY/TEST.xml" -OutputFormat NUnitXml -EnableExit
        displayName: Pester unit tests
      - task: PublishTestResults@2
        inputs:
          testResultsFormat: NUnit
          testResultsFiles: '$(Build.SourcesDirectory)/TEST.xml'
        displayName: Publish test result
  - job: CodeSign
    dependsOn: Test
    pool:
      name: Package ES CodeHub Lab E
    steps:
      - task: PowerShell@2
        inputs:
          pwsh: 'false'
          targetType: inline
          script: |
            New-Item $env:BUILD_ARTIFACTSTAGINGDIRECTORY/GuestConfiguration -type Directory
            Copy-Item -Path $env:BUILD_SOURCESDIRECTORY/DscResources -Destination $env:BUILD_ARTIFACTSTAGINGDIRECTORY/GuestConfiguration/DscResources -Recurse
            Copy-Item -Path $env:BUILD_SOURCESDIRECTORY/GuestConfiguration.psd1 -Destination $env:BUILD_ARTIFACTSTAGINGDIRECTORY/GuestConfiguration/GuestConfiguration.psd1
            Copy-Item -Path $env:BUILD_SOURCESDIRECTORY/LICENSE -Destination $env:BUILD_ARTIFACTSTAGINGDIRECTORY/GuestConfiguration/LICENSE
        displayName: Stage module artifact
      - task: UniversalPackages@0
        inputs:
          command: download
          feedsToUse: external
          externalFeedCredentials: guestconfiguration
          feedDownloadExternal: guestconfiguration
          packageDownloadExternal: gc_agents
          versionDownloadExternal: '*'
          downloadDirectory: '$(Build.ArtifactStagingDirectory)\GuestConfiguration\bin\'
        displayName: Universal download
      - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
        inputs:
          failOnAlert: true
        displayName: 'Component Detection'
      - task: PkgESCodeSign@10
        env:
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        inputs:
          signConfigXml: '$(Build.SourcesDirectory)\tools\SignConfig.xml'
          inPathRoot: '$(Build.SourcesDirectory)'
          outPathRoot: '$(Build.ArtifactStagingDirectory)\GuestConfiguration'
        displayName: 'CodeSign'
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)\GuestConfiguration'
          artifactName: GuestConfiguration
        displayName: Publish artifact
